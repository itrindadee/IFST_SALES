<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro de Cliente</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
  <div class="container mt-5">
    <h1 class="text-center">Cadastro de Cliente</h1>

    <!-- Formulário de filtro -->
    <form method="GET" action="/clientes/listar" class="mb-4">
      <div class="form-row">
        <div class="form-group col-md-4">
          <label for="codigo">Código do Cliente:</label>
          <input type="text" class="form-control" id="codigo" name="codigo" value="<%= typeof codigo !== 'undefined' ? codigo : '' %>">
        </div>
        <div class="form-group col-md-4">
          <label for="empresa">Empresa:</label>
          <input type="text" class="form-control" id="empresa" name="empresa" value="<%= typeof empresa !== 'undefined' ? empresa : '' %>">
        </div>
        <div class="form-group col-md-4">
          <label for="organizacaoVendas">Organização de Vendas:</label>
          <input type="text" class="form-control" id="organizacaoVendas" name="organizacaoVendas" value="<%= typeof organizacaoVendas !== 'undefined' ? organizacaoVendas : '' %>">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group col-md-4">
          <label for="cpf">CPF:</label>
          <input type="text" class="form-control" id="cpf" name="cpf" value="<%= typeof cpf !== 'undefined' ? cpf : '' %>">
        </div>
        <div class="form-group col-md-4">
          <label for="cnpj">CNPJ:</label>
          <input type="text" class="form-control" id="cnpj" name="cnpj" value="<%= typeof cnpj !== 'undefined' ? cnpj : '' %>">
        </div>
        <div class="form-group col-md-4 d-flex align-items-end justify-content-end">
          <!-- Botão Filtrar (alinhado à direita) -->
          <button type="filtrar" class="btn btn-primary">Filtrar</button>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group col-md-12 d-flex justify-content-end">
          <!-- Botão Cadastrar (alinhado à direita) -->
          <button id="openAddClienteModalButton" type="button" class="btn btn-primary">Adicionar Cliente</button>
        </div>
      </div>
    </form>

    <!-- Tabela de clientes -->
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Código</th>
          <th>Razão Social</th>
          <th>Empresa</th>
          <th>Organização de Vendas</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        <% clientes.forEach(cliente => { %>
          <tr>
            <td><%= cliente.codigo %></td>
            <td><%= cliente.razaoSocial %></td>
            <td><%= cliente.empresa %></td>
            <td><%= cliente.organizacaoVendas %></td>
            <td>
              <button class="btn btn-warning btn-sm" data-toggle="modal" data-target="#editClienteModal<%= cliente.id %>">Editar</button>
              <button class="btn btn-danger btn-sm" id="deleteButton<%= cliente.id %>">Deletar</button>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <!-- Modal para adicionar cliente -->
  <div class="modal fade" id="addClienteModal" tabindex="-1" role="dialog" aria-labelledby="addClienteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addClienteModalLabel">Adicionar Cliente</h5>
        </div>
        <div class="modal-body">
          <form id="addClienteForm">
            <div class="form-group">
              <div class="form-group">

                <label for="cpf">CPF:</label>
                <input type="text" class="form-control" id="ClienteModalcpf" name="cpf">
              </div>
              <div class="form-group">
                <label for="cnpj">CNPJ:</label>
                <input type="text" class="form-control" id="ClienteModalcnpj" name="cnpj">
              </div>
              <label for="modal.empresa">Empresa:</label>
              <select class="form-control" id="modal.empresa" name="empresa" required>
                <!-- Options will be populated by JavaScript -->
              </select>
            </div>
            <div class="form-group">
              <label for="modal.organizacaoVendas">Organização de Vendas:</label>
              <select class="form-control" id="modal.organizacaoVendas" name="organizacaoVendas" required>
                <!-- Options will be populated by JavaScript -->
              </select>
            </div>
            <!-- Outros campos do cliente aqui... -->
            <div class="d-flex justify-content-between">
              <button type="button" class="btn btn-primary" id="verificarCadastroSubmit">Prosseguir</button>
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            </div>
            </form>
          </div>
        </div>
      </div>
    </div>

<!-- Modal para cadastrar cliente -->
<div class="modal fade" id="cadastroClienteModal" tabindex="-1" role="dialog" aria-labelledby="cadastroClienteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <!-- Cabeçalho do Modal -->
      <div class="modal-header">
        <h5 class="modal-title" id="cadastroClienteModalLabel">Cadastro de Novo Cliente</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <!-- Corpo do Modal -->
      <div class="modal-body">
        <!-- Abas -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
          <li class="nav-item">
            <a class="nav-link active" id="infoGeral-tab" data-toggle="tab" href="#infoGeral" role="tab" aria-controls="infoGeral" aria-selected="true">Informação Geral</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="endereco-tab" data-toggle="tab" href="#endereco" role="tab" aria-controls="endereco" aria-selected="false">Endereço</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="empresa-tab" data-toggle="tab" href="#empresa" role="tab" aria-controls="empresa" aria-selected="false">Empresa</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="orgVendas-tab" data-toggle="tab" href="#orgVendas" role="tab" aria-controls="orgVendas" aria-selected="false">Organização de Vendas</a>
          </li>
        </ul>
        <!-- Conteúdo das Abas -->
        <div class="tab-content" id="myTabContent">
          <!-- Aba Informação Geral -->
          <div class="tab-pane fade show active" id="infoGeral" role="tabpanel" aria-labelledby="infoGeral-tab">
            <form id="formCadastroCliente">
              <div class="form-group">
                <label for="codigoCliente">Código:</label>
                <input type="text" class="form-control" id="codigoCliente" name="codigoCliente" required>
              </div>
              <div class="form-group">
                <label for="razaoSocialCliente">Razão Social:</label>
                <input type="text" class="form-control" id="razaoSocialCliente" name="razaoSocialCliente" required>
              </div>
              <div class="form-group">
                <label for="tipoCliente">Tipo de Cliente:</label>
                <input type="text" class="form-control" id="tipoCliente" name="tipoCliente" required>
              </div>
              <div class="form-group">
                <label for="grupoContasCliente">Grupo de Contas:</label>
                <input type="text" class="form-control" id="grupoContasCliente" name="grupoContasCliente">
              </div>
              <div class="form-group">
                <label for="termoPesquisaCliente">Termo de Pesquisa:</label>
                <input type="text" class="form-control" id="termoPesquisaCliente" name="termoPesquisaCliente">
              </div>
              <div class="form-group">
                <label for="telefoneCliente">Telefone:</label>
                <input type="text" class="form-control" id="telefoneCliente" name="telefoneCliente">
              </div>
              <div class="form-group">
                <label for="telefone2Cliente">Telefone 2:</label>
                <input type="text" class="form-control" id="telefone2Cliente" name="telefone2Cliente">
              </div>
              <div class="form-group">
                <label for="emailCliente">Email:</label>
                <input type="email" class="form-control" id="emailCliente" name="emailCliente">
              </div>
              <div class="form-group">
                <label for="cnpjCliente">CNPJ:</label>
                <input type="text" class="form-control" id="cnpjCliente" name="cnpjCliente">
              </div>
              <div class="form-group">
                <label for="cpfCliente">CPF:</label>
                <input type="text" class="form-control" id="cpfCliente" name="cpfCliente">
              </div>
              <div class="form-group">
                <label for="inscEstadualCliente">Inscrição Estadual:</label>
                <input type="text" class="form-control" id="inscEstadualCliente" name="inscEstadualCliente">
              </div>
              <div class="form-group">
                <label for="inscMunicipalCliente">Inscrição Municipal:</label>
                <input type="text" class="form-control" id="inscMunicipalCliente" name="inscMunicipalCliente">
                </div>
                </form>
                </div>
                <!-- Aba Endereço -->
                <div class="tab-pane fade" id="endereco" role="tabpanel" aria-labelledby="endereco-tab">
                <form id="formEnderecoCliente">
                <div class="form-group">
                <label for="ruaCliente">Rua:</label>
                <input type="text" class="form-control" id="ruaCliente" name="ruaCliente">
                </div>
                <div class="form-group">
                <label for="rua2Cliente">Rua 2:</label>
                <input type="text" class="form-control" id="rua2Cliente" name="rua2Cliente">
                </div>
                <div class="form-group">
                <label for="rua3Cliente">Rua 3:</label>
                <input type="text" class="form-control" id="rua3Cliente" name="rua3Cliente">
                </div>
                <div class="form-group">
                <label for="cepCliente">CEP:</label>
                <input type="text" class="form-control" id="cepCliente" name="cepCliente">
                </div>
                <div class="form-group">
                <label for="paisCliente">País:</label>
                <input type="text" class="form-control" id="paisCliente" name="paisCliente">
                </div>
                <div class="form-group">
                <label for="regiaoCliente">Região:</label>
                <input type="text" class="form-control" id="regiaoCliente" name="regiaoCliente">
                </div>
                <div class="form-group">
                <label for="domicilioFiscalCliente">Domicílio Fiscal:</label>
                <input type="text" class="form-control" id="domicilioFiscalCliente" name="domicilioFiscalCliente">
                </div>
                <div class="form-group">
                <label for="ufCliente">UF:</label>
                <input type="text" class="form-control" id="ufCliente" name="ufCliente">
                </div>
                <div class="form-group">
                <label for="bairroCliente">Bairro:</label>
                <input type="text" class="form-control" id="bairroCliente" name="bairroCliente">
                </div>
                <div class="form-group">
                <label for="cidadeCliente">Cidade:</label>
                <input type="text" class="form-control" id="cidadeCliente" name="cidadeCliente">
                </div>
                <div class="form-group">
                <label for="numeroCliente">Número:</label>
                <input type="text" class="form-control" id="numeroCliente" name="numeroCliente">
                </div>
                <div class="form-group">
                <label for="complementoCliente">Complemento:</label>
                <input type="text" class="form-control" id="complementoCliente" name="complementoCliente">
                </div>
                <div class="form-group">
                <label for="observacaoEnderecoCliente">Observação de Endereço:</label>
                <input type="text" class="form-control" id="observacaoEnderecoCliente" name="observacaoEnderecoCliente">
                </div>
                </form>
                </div>
                <!-- Aba Empresa -->
                <div class="tab-pane fade" id="empresa" role="tabpanel" aria-labelledby="empresa-tab">
                <form id="formCadastroEmpresa">
                <div class="form-group">
                <label for="grupoEmpresaCliente">Grupo de Empresa:</label>
                <input type="text" class="form-control" id="grupoEmpresaCliente" name="grupoEmpresaCliente">
                </div>
                <div class="form-group">
                <label for="transportadoraCliente">Transportadora:</label>
                <input type="text" class="form-control" id="transportadoraCliente" name="transportadoraCliente">
                </div>
                <div class="form-group">
                <label for="diasParaExpedicaoCliente">Dias para Expedição:</label>
                <input type="number" class="form-control" id="diasParaExpedicaoCliente" name="diasParaExpedicaoCliente">
                </div>
                <div class="form-group">
                <label for="distritoCliente">Distrito:</label>
                <input type="text" class="form-control" id="distritoCliente" name="distritoCliente">
                </div>
                </form>
                </div>
                <!-- Aba Organização de Vendas -->
                <div class="tab-pane fade" id="orgVendas" role="tabpanel" aria-labelledby="orgVendas-tab">
                <form id="formCadastroOrgVendas">
                <div class="form-group">
                <label for="comissaoCliente">Comissão:</label>
                <input type="number" class="form-control" id="comissaoCliente" name="comissaoCliente">
                </div>
                <div class="form-group">
                <label for="despesasBancariasCliente">Despesas Bancárias:</label>
                <input type="number" class="form-control" id="despesasBancariasCliente" name="despesasBancariasCliente">
                </div>
                <div class="form-group">
                  <label for="prazoPagamentoCliente">Prazo de Pagamento:</label>
                  <input type="text" class="form-control" id="prazoPagamentoCliente" name="prazoPagamentoCliente">
                </div>
                <div class="form-group">
                  <label for="meioTransporteCliente">Meio de Transporte:</label>
                  <input type="text" class="form-control" id="meioTransporteCliente" name="meioTransporteCliente">
                </div>
                <div class="form-group">
                  <label for="moedaCliente">Moeda:</label>
                  <input type="text" class="form-control" id="moedaCliente" name="moedaCliente">
                </div>
                <div class="form-group">
                  <label for="representanteCliente">Representante:</label>
                  <input type="text" class="form-control" id="representanteCliente" name="representanteCliente">
                </div>
                <div class="form-group">
                  <label for="descontoCliente">Desconto:</label>
                  <input type="number" class="form-control" id="descontoCliente" name="descontoCliente">
                </div>
              </form>
            </div>
          </div>
        </div>
        <!-- Rodapé do Modal -->
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="cadastrarClienteSubmit">Cadastrar Cliente</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>



    <!-- Modais de edição de cliente (um para cada cliente) -->
    <% clientes.forEach(cliente => { %>
      <div class="modal fade" id="editClienteModal<%= cliente.id %>" tabindex="-1" role="dialog" aria-labelledby="editClienteModalLabel<%= cliente.id %>" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editClienteModalLabel<%= cliente.id %>">Editar Cliente</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form id="editClienteForm<%= cliente.id %>">

                <input type="hidden" name="id" value="<%= cliente.id %>">
                <div class="form-group">
                  <label for="codigo<%= cliente.id %>">Código:</label>
                  <input type="text" class="form-control" id="codigo<%= cliente.id %>" name="codigo" value="<%= cliente.codigo %>" required>
                </div>
                <div class="form-group">
                  <label for="empresa<%= cliente.id %>">Empresa:</label>
                  <input type="text" class="form-control" id="empresa<%= cliente.id %>" name="empresa" value="<%= cliente.empresa %>" required>
                </div>
                <div class="form-group">
                  <label for="organizacaoVendas<%= cliente.id %>">Organização de Vendas:</label>
                  <input type="text" class="form-control" id="organizacaoVendas<%= cliente.id %>" name="organizacaoVendas" value="<%= cliente.organizacaoVendas %>" required>
                </div>
                <!-- Outros campos do cliente aqui... -->
                <button type="submit" class="btn btn-primary">Salvar Alterações</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    <% }) %>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('openAddClienteModalButton').addEventListener('click', openAddClienteModal);
        document.getElementById('verificarCadastroSubmit').addEventListener('click', verificarCadastroModal);
      });

      async function fetchCadastroData() {
        try {
          const response = await fetch('/clientes/renderizarcadastro');
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          const data = await response.json();
          return data;
        } catch (error) {
          console.error('There was a problem with the fetch operation:', error);
        }
      }

      function populateSelect(elementId, options) {
        const selectElement = document.getElementById(elementId);
        selectElement.innerHTML = '';
        options.forEach(option => {
          const optionElement = document.createElement('option');
          optionElement.value = option.id;
          optionElement.textContent = option.codigo; // Usando apenas o código
          selectElement.appendChild(optionElement);
        });
      }

      async function openAddClienteModal() {
        const data = await fetchCadastroData();
        if (data) {
          populateSelect('modal.empresa', data.empresas);
          populateSelect('modal.organizacaoVendas', data.organizacoesVendas);
          $('#addClienteModal').modal('show');
        }
      }

      async function verificarCadastroModal() {
        // Captura os valores dos campos do formulário
        const cpf = document.getElementById('ClienteModalcpf').value;
        const cnpj = document.getElementById('ClienteModalcnpj').value;
        const empresaId = document.getElementById('empresa').value;
        const organizacaoVendasId = document.getElementById('organizacaoVendas').value;

        // Verifica se pelo menos um dos campos foi preenchido
        if (!cpf && !cnpj) {
          alert('Preencha pelo menos um dos campos: CPF ou CNPJ.');
          return;
        } else if (cpf && cnpj) {
          alert('Preencha apenas um dos campos: CPF ou CNPJ.');
          return;
        }

        // Tenta fazer uma requisição para verificar se o cliente existe
        try {
          const response = await fetch(`/clientes/validar?cnpj=${ClienteModalcnpj}&cpf=${ClienteModalcpf}&empresa=${empresaId}&organizacaoVendas=${organizacaoVendasId}`);
          if (response.ok) {
            const clienteExistente = await response.json();
            if (clienteExistente) {
              // Verifica se o cliente já está cadastrado para esta empresa e organização de vendas
              if (clienteExistente.empresa && clienteExistente.organizacaoVendas) {
                alert('Cliente já cadastrado para esta empresa e organização de vendas.');
              } else {
                // Abre o modal para cadastro de empresa e organização de vendas
                $('#addClienteModal').modal('hide'); // Fecha o modal existente
                $('#cadastroEmpresaOrganizacaoModal').modal('show');
              }
            } else {
                // Define os valores recuperados nos campos correspondentes do outro modal
              $('#cpfCliente').val(cpf || cnpj); // Define o CPF se existir, senão define o CNPJ
              $('#cnpjCliente').val(cpf ? 'CPF' : 'CNPJ'); // Define 'CPF' se CPF estiver preenchido, senão define 'CNPJ'
              $('#empresaCliente').val(empresa); // Define a empresa
              $('#organizacaoVendasCliente').val(organizacaoVendas); // Define a organização de vendas
              // Se o cliente não existe, abre o modal de cadastro de cliente
              $('#addClienteModal').modal('hide'); // Fecha o modal existente
              $('#cadastroClienteModal').modal('show');
            }
          } else {
            alert('Erro ao verificar cliente.');
          }
        } catch (err) {
          console.error('Erro ao verificar cliente:', err);
          alert('Erro ao verificar cliente.');
        }
      }
    </script>
  </body>
  </html>
