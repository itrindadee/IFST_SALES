<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro de Cliente</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
  <div class="container mt-5">
    <h1 class="text-center">Cadastro de Cliente</h1>

    <!-- Formulário de filtro -->
    <form method="GET" action="/clientes/listar" class="mb-4">
      <div class="form-row">
        <div class="form-group col-md-4">
          <label for="codigo">Código do Cliente:</label>
          <input type="text" class="form-control" id="codigo" name="codigo" value="<%= typeof codigo !== 'undefined' ? codigo : '' %>">
        </div>
        <div class="form-group col-md-4">
          <label for="empresa">Empresa:</label>
          <input type="text" class="form-control" id="empresa" name="empresa" value="<%= typeof empresa !== 'undefined' ? empresa : '' %>">
        </div>
        <div class="form-group col-md-4">
          <label for="organizacaoVendas">Organização de Vendas:</label>
          <input type="text" class="form-control" id="organizacaoVendas" name="organizacaoVendas" value="<%= typeof organizacaoVendas !== 'undefined' ? organizacaoVendas : '' %>">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group col-md-4">
          <label for="cpf">CPF:</label>
          <input type="text" class="form-control" id="cpf" name="cpf" value="<%= typeof cpf !== 'undefined' ? cpf : '' %>">
        </div>
        <div class="form-group col-md-4">
          <label for="cnpj">CNPJ:</label>
          <input type="text" class="form-control" id="cnpj" name="cnpj" value="<%= typeof cnpj !== 'undefined' ? cnpj : '' %>">
        </div>
        <div class="form-group col-md-4 d-flex align-items-end justify-content-end">
          <!-- Botão Filtrar (alinhado à direita) -->
          <button type="filtrar" class="btn btn-primary">Filtrar</button>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group col-md-12 d-flex justify-content-end">
          <!-- Botão Cadastrar (alinhado à direita) -->
          <button id="openAddClienteModalButton" type="button" class="btn btn-primary">Adicionar Cliente</button>
        </div>
      </div>
    </form>

    <!-- Tabela de clientes -->
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Código</th>
          <th>Razão Social</th>
          <th>Empresa</th>
          <th>Organização de Vendas</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        <% clientes.forEach(cliente => { %>
          <tr>
            <td><%= cliente.codigo %></td>
            <td><%= cliente.razaoSocial %></td>
            <td><%= cliente.empresa %></td>
            <td><%= cliente.organizacaoVendas %></td>
            <td>
              <button class="btn btn-warning btn-sm" data-toggle="modal" data-target="#editClienteModal<%= cliente.id %>">Editar</button>
              <button class="btn btn-danger btn-sm" id="deleteButton<%= cliente.id %>">Deletar</button>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <!-- Modal para adicionar cliente -->
  <div class="modal fade" id="addClienteModal" tabindex="-1" role="dialog" aria-labelledby="addClienteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addClienteModalLabel">Adicionar Cliente</h5>
        </div>
        <div class="modal-body">
          <form id="addClienteForm">
            <div class="form-group">
              <div class="form-group">

                <label for="cpf">CPF:</label>
                <input type="text" class="form-control" id="ClienteModalcpf" name="cpf">
              </div>
              <div class="form-group">
                <label for="cnpj">CNPJ:</label>
                <input type="text" class="form-control" id="ClienteModalcnpj" name="cnpj">
              </div>
              <label for="modal.empresa">Empresa:</label>
              <select class="form-control" id="modal.empresa" name="empresa" required>
                <!-- Options will be populated by JavaScript -->
              </select>
            </div>
            <div class="form-group">
              <label for="modal.organizacaoVendas">Organização de Vendas:</label>
              <select class="form-control" id="modal.organizacaoVendas" name="organizacaoVendas" required>
                <!-- Options will be populated by JavaScript -->
              </select>
            </div>
            <!-- Outros campos do cliente aqui... -->
            <div class="d-flex justify-content-between">
              <button type="button" class="btn btn-primary" id="verificarCadastroSubmit">Prosseguir</button>
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            </div>
            </form>
          </div>
        </div>
      </div>
    </div>

<!-- Modal para cadastrar cliente -->

<div class="modal fade bd-example-modal-xl" tabindex="-1" id="cadastroClienteModal" role="dialog" aria-labelledby="cadastroClienteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="myExtraLargeModalLabel">Cadastro de Cliente</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
              </button>
          </div>
          <div class="modal-body">
              <ul class="nav nav-tabs" id="clienteTabs" role="tablist">
                  <li class="nav-item">
                      <a class="nav-link active" id="geral-tab" data-toggle="tab" href="#geral" role="tab" aria-controls="geral" aria-selected="true">Geral</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" id="dados-controle-tab" data-toggle="tab" href="#dados-controle" role="tab" aria-controls="dados-controle" aria-selected="false">Dados de Controle</a>
                  </li>
              </ul>
              <div class="tab-content" id="clienteTabContent">
                  <div class="tab-pane fade show active" id="geral" role="tabpanel" aria-labelledby="geral-tab">
                      <form id="clienteForm">
                          <!-- Seção Geral -->
                          <div class="form-group">
                              <h5>Geral</h5>
                              <div class="row">
                                  <div class="col-md-8">
                                      <label for="nome">Nome</label>
                                      <input type="text" class="form-control" id="nome" required>
                                  </div>
                                  <div class="col-md-4">
                                      <label for="termoPesquisa">Termo de Pesquisa</label>
                                      <input type="text" class="form-control" id="termoPesquisa">
                                  </div>
                              </div>
                          </div>
                          <!-- Seção Endereço -->
                          <div class="form-group mt-3">
                              <h5>Endereço</h5>
                              <div class="row">
                                  <div class="col-md-2">
                                      <label for="cep">CEP</label>
                                      <input type="text" class="form-control" id="cep">
                                  </div>
                                  <div class="col-md-2">
                                      <label for="domicilio">Domicílio</label>
                                      <input type="text" class="form-control" id="domicilio">
                                  </div>
                              </div>
                              <div class="row">
                                  <div class="col-md-8">
                                      <label for="rua">Rua</label>
                                      <input type="text" class="form-control" id="rua">
                                  </div>
                                  <div class="col-md-2">
                                      <label for="numero">Número</label>
                                      <input type="text" class="form-control" id="numero">
                                  </div>
                              </div>
                              <div class="row">
                                  <div class="col-md-4">
                                      <label for="bairro">Bairro</label>
                                      <input type="text" class="form-control" id="bairro">
                                  </div>
                                  <div class="col-md-4">
                                      <label for="cidade">Cidade</label>
                                      <input type="text" class="form-control" id="cidade">
                                  </div>
                                  <div class="col-md-1">
                                      <label for="pais">País</label>
                                      <input type="text" class="form-control" id="pais">
                                  </div>
                                  <div class="col-md-1">
                                      <label for="regiao">Região</label>
                                      <input type="text" class="form-control" id="regiao">
                                  </div>
                              </div>
                          </div>
                          <!-- Seção Comunicação -->
                          <div class="form-group mt-4">
                              <h5>Comunicação</h5>
                              <div class="row">
                                  <div class="col-md-3">
                                      <label for="idioma">Idioma</label>
                                      <input type="text" class="form-control" id="idioma">
                                  </div>
                              </div>
                              <div class="row mt-3">
                                  <div class="col-md-4">
                                      <label for="telefone">Telefone</label>
                                      <input type="text" class="form-control" id="telefone">
                                  </div>
                                  <div class="col-md-4">
                                      <label for="telefone2">Telefone 2</label>
                                      <input type="text" class="form-control" id="telefone2">
                                  </div>
                              </div>
                              <div class="row mt-3">
                                  <div class="col-md-6">
                                      <label for="email">Email</label>
                                      <input type="email" class="form-control" id="email">
                                  </div>
                              </div>
                          </div>
                      </form>
                  </div>
                  <div class="tab-pane fade" id="dados-controle" role="tabpanel" aria-labelledby="dados-controle-tab">
                      <!-- Conteúdo da aba Dados de Controle -->
                      <div class="form-group">
                          <label for="fornecedor">Fornecedor</label>
                          <input type="text" class="form-control" id="fornecedor">
                      </div>
                      <div class="form-group">
                          <label for="grupoEmpresa">Grupo Empresa</label>
                          <input type="text" class="form-control" id="grupoEmpresa">
                      </div>
                      <div class="form-group">
                          <label for="cnpj">CNPJ</label>
                          <input type="text" class="form-control" id="cnpj">
                      </div>
                      <div class="form-group">
                          <label for="cpf">CPF</label>
                          <input type="text" class="form-control" id="cpf">
                      </div>
                      <div class="form-group">
                          <label for="inscEstadual">Insc. Estadual</label>
                          <input type="text" class="form-control" id="inscEstadual">
                      </div>
                      <div class="form-group">
                          <label for="inscMunicipal">Insc. Municipal</label>
                          <input type="text" class="form-control" id="inscMunicipal">
                        </div>
                        <div class="form-group">
                            <label for="ctgCFOP">Ctg CFOP</label>
                            <input type="text" class="form-control" id="ctgCFOP">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary">Salvar</button>
            </div>
        </div>
    </div>
</div>





    <!-- Modais de edição de cliente (um para cada cliente) -->
    <% clientes.forEach(cliente => { %>
      <div class="modal fade" id="editClienteModal<%= cliente.id %>" tabindex="-1" role="dialog" aria-labelledby="editClienteModalLabel<%= cliente.id %>" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editClienteModalLabel<%= cliente.id %>">Editar Cliente</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form id="editClienteForm<%= cliente.id %>">

                <input type="hidden" name="id" value="<%= cliente.id %>">
                <div class="form-group">
                  <label for="codigo<%= cliente.id %>">Código:</label>
                  <input type="text" class="form-control" id="codigo<%= cliente.id %>" name="codigo" value="<%= cliente.codigo %>" required>
                </div>
                <div class="form-group">
                  <label for="empresa<%= cliente.id %>">Empresa:</label>
                  <input type="text" class="form-control" id="empresa<%= cliente.id %>" name="empresa" value="<%= cliente.empresa %>" required>
                </div>
                <div class="form-group">
                  <label for="organizacaoVendas<%= cliente.id %>">Organização de Vendas:</label>
                  <input type="text" class="form-control" id="organizacaoVendas<%= cliente.id %>" name="organizacaoVendas" value="<%= cliente.organizacaoVendas %>" required>
                </div>
                <!-- Outros campos do cliente aqui... -->
                <button type="submit" class="btn btn-primary">Salvar Alterações</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    <% }) %>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
          document.getElementById('openAddClienteModalButton').addEventListener('click', openAddClienteModal);
          document.getElementById('verificarCadastroSubmit').addEventListener('click', verificarCadastroModal);

          // Selecione o campo de entrada do CEP
          const cepInput = document.getElementById('cep');

          // Adicione um evento de escuta para o evento 'blur'
          cepInput.addEventListener('blur', function() {
              // Obtém o valor do CEP do campo de entrada
              const cepValue = cepInput.value;

              // Verifica se o CEP possui um valor válido
              if (cepValue.trim() !== '') {
                  // Remove qualquer formatação existente
                  const cepFormatted = cepValue.replace(/\D/g, '');

                  // Formata o CEP XXXXX-XXX
                  const cepFormattedDisplay = cepFormatted.replace(/^(\d{5})(\d{3})/, '$1-$2');

                  // Define o valor formatado no campo de entrada
                  cepInput.value = cepFormattedDisplay;

                  // Chama a função buscarCEP com o valor do CEP como parâmetro
                  buscarCEP(cepFormatted);
              }
          });
      });

      async function fetchCadastroData() {
          try {
              const response = await fetch('/clientes/renderizarcadastro');
              if (!response.ok) {
                  throw new Error('Network response was not ok');
              }
              const data = await response.json();
              return data;
          } catch (error) {
              console.error('There was a problem with the fetch operation:', error);
          }
      }

      function populateSelect(elementId, options) {
          const selectElement = document.getElementById(elementId);
          selectElement.innerHTML = '';
          options.forEach(option => {
              const optionElement = document.createElement('option');
              optionElement.value = option.id;
              optionElement.textContent = option.codigo; // Usando apenas o código
              selectElement.appendChild(optionElement);
          });
      }

      async function openAddClienteModal() {
          const data = await fetchCadastroData();
          if (data) {
              populateSelect('modal.empresa', data.empresas);
              populateSelect('modal.organizacaoVendas', data.organizacoesVendas);
              $('#addClienteModal').modal('show');
          }
      }

      async function verificarCadastroModal() {
          // Captura os valores dos campos do formulário
          const cpf = document.getElementById('ClienteModalcpf').value;
          const cnpj = document.getElementById('ClienteModalcnpj').value;
          const empresaId = document.getElementById('empresa').value;
          const organizacaoVendasId = document.getElementById('organizacaoVendas').value;

          // Verifica se pelo menos um dos campos foi preenchido
          if (!cpf && !cnpj) {
              alert('Preencha pelo menos um dos campos: CPF ou CNPJ.');
              return;
          } else if (cpf && cnpj) {
              alert('Preencha apenas um dos campos: CPF ou CNPJ.');
              return;
          }

          // Tenta fazer uma requisição para verificar se o cliente existe
          try {
              const response = await fetch(`/clientes/validar?cnpj=${ClienteModalcnpj}&cpf=${ClienteModalcpf}&empresa=${empresaId}&organizacaoVendas=${organizacaoVendasId}`);
              if (response.ok) {
                  const clienteExistente = await response.json();
                  if (clienteExistente) {
                      // Verifica se o cliente já está cadastrado para esta empresa e organização de vendas
                      if (clienteExistente.empresa && clienteExistente.organizacaoVendas) {
                          alert('Cliente já cadastrado para esta empresa e organização de vendas.');
                      } else {
                          // Abre o modal para cadastro de empresa e organização de vendas
                          $('#addClienteModal').modal('hide'); // Fecha o modal existente
                          $('#cadastroEmpresaOrganizacaoModal').modal('show');
                      }
                  } else {
                      // Define os valores recuperados nos campos correspondentes do outro modal
                      $('#cpfCliente').val(cpf || cnpj); // Define o CPF se existir, senão define o CNPJ
                      $('#cnpjCliente').val(cpf ? 'CPF' : 'CNPJ'); // Define 'CPF' se CPF estiver preenchido, senão define 'CNPJ'
                      $('#empresaCliente').val(empresa); // Define a empresa
                      $('#organizacaoVendasCliente').val(organizacaoVendas); // Define a organização de vendas
                      // Se o cliente não existe, abre o modal de cadastro de cliente
                      $('#addClienteModal').modal('hide'); // Fecha o modal existente
                      $('#cadastroClienteModal').modal('show');
                  }
              } else {
                  alert('Erro ao verificar cliente.');
              }
          } catch (err) {
              console.error('Erro ao verificar cliente:', err);
              alert('Erro ao verificar cliente.');
          }
      }

      function buscarCEP(cep) {
          // Endpoint do ViaCEP
          const endpoint = `https://viacep.com.br/ws/${cep}/json/`;

          // Envia a requisição para o endpoint
          fetch(endpoint)
              .then(response => {
                  // Verifica se a resposta foi bem-sucedida
                  if (!response.ok) {
                      throw new Error('Erro ao buscar o CEP');
                  }
                  // Converte a resposta para JSON
                  return response.json();
              })
              .then(data => {
                  // Preenche os campos de endereço com os dados retornados
                  document.getElementById('rua').value = data.logradouro;
                  document.getElementById('bairro').value = data.bairro;
                  document.getElementById('cidade').value = data.localidade;
                  document.getElementById('regiao').value = data.uf;
                  // Concatena UF e IBGE com um espaço entre eles
                  const domicilioValue = `${data.uf || ''} ${data.ibge || ''}`;
                  document.getElementById('domicilio').value = domicilioValue.trim();
                  // Aqui você pode manipular os dados retornados, como preencher os campos de endereço em um formulário
              })
              .catch(error => {
                  // Trata erros de requisição
                  console.error('Erro ao buscar o CEP:', error);
              });
      }
  </script>
  </body>
  </html>
